<html>
  <head>
    <title>TripVision Single Sign-On</title>
    <script>
      const API_BASE_URL = 'https://tvapi2qa.noregon.com/api/v2/i/users/';
      const TRIPVISION_BASE_URL = 'https://tripvisionqa.noregon.com/';

      console.log('May 5th Geotab Plugin');
      initializeGeotabAddin();

      function initializeGeotabAddin() {
        geotab.addin.myCustomPage1 = () => {
          return {
            initialize(api, state, callback) {
              console.log('Add-in initialized');

              // Automatically calls SSOWrapper when the page is loaded
              SSOWrapper();

              function SSOWrapper() {
                try {
                  logUserDetails();
                  SSOfunction();
                } catch (error) {
                  console.error('Error in SSOWrapper:', error);
                  // redirectToTripVision('auth');
                }
              }

              function logUserDetails() {
                api.getSession(function (session) {
                  const userName = session.userName;
                  console.log(JSON.stringify(session.sessionId));
                  api.call(
                    'Get',
                    {
                      typeName: 'User',
                      resultsLimit: 1,
                      propertySelector: { fields: ['id', 'companyGroups'] },
                      search: { name: userName },
                    },
                    function (apiresult) {
                      const userId = apiresult[0].id;
                      const companyGroups = apiresult[0].companyGroups
                        .map((group) => group.id)
                        .join(', ');

                      console.log('User ID:', userId);
                      console.log('Company Groups:', companyGroups);
                    },
                  );
                });
              }

              // fetch(`${API_BASE_URL}log-in-geotab?Username=${JSON.stringify(session.userName)}&DatabaseName=${JSON.stringify(session.database)}&SessionID=${JSON.stringify(session.sessionId)}&ServerName=${JSON.stringify(server)}`, {

              function SSOfunction() {
                api.getSession(function (session, server) {
                  console.log('Session:', session);
                  fetch(
                    `${API_BASE_URL}log-in-geotab?Username=${session.userName}&DatabaseName=${session.database}&SessionID=${session.sessionId}&ServerName=${server}`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        Username: session.userName,
                        DatabaseName: session.database,
                        SessionID: session.sessionId,
                        ServerName: server,
                      }),
                    },
                  )
                    .then((response) => {
                      if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                      }
                      return response.json();
                    })
                    .then((data) => {
                      console.log('Successfully called TV API:', data);

                      if (data.ViewWhatsNew) {
                        console.log("User should view What's New modal");
                        redirectToTripVision('whats-new');
                      } else if (data.ReturnCode !== 0) {
                        console.error('Error in login response:', data.ErrorMessage);
                        redirectToTripVision('auth');
                        return;
                      }

                      const loginToken = data.Token;
                      const userInfo = data.LogInUserInfo;
                      const userPreferences = data.UserPreferences;
                      loginUser(loginToken, data.userInfo, data.userPreferences, data);
                    })
                    .catch((error) => {
                      console.error('Error retrieving token:', error);
                      redirectToTripVision('auth');
                    });
                });
              }

              function redirectToTripVision(route) {
                const iframe = document.getElementById('login-iframe');
                const src = `${TRIPVISION_BASE_URL}${route}`;

                if (iframe) {
                  iframe.src = src; // Update the iframe's src attribute to redirect
                  console.log('Redirecting iframe to:', src);
                } else {
                  console.error('Iframe not found. Unable to redirect.');
                }
                return;
              }

              function loginUser(token, userInfo, userPreferences, userdata) {
                const currentUser = {
                  Token: token,
                  LogInUserInfo: userInfo,
                  UserPreferences: userPreferences,
                  ReturnCode: 0, // Ensure ReturnCode is 0 for successful authentication
                };

                const iframe = document.getElementById('login-iframe');

                if (iframe) {
                  // Listen for the "READY" message from the iframe
                  window.addEventListener('message', function handleReadyMessage(event) {
                    if (event.data && event.data.type === 'READY') {
                      console.log('Iframe is ready to receive messages.');

                      // Send data to the iframe using postMessage
                      iframe.contentWindow.postMessage(
                        {
                          type: 'SET_LOCAL_STORAGE',
                          data: {
                            auth_token_V2: token,
                            current_user: JSON.stringify(userdata), 
                            loggedInBusinessId: userdata.LogInUserInfo.BusinessId,
                            isSSO: 'true',
                          },
                        },
                        '*', // Replace '*' with the iframe's origin for security
                      );

                      console.log('Sent data to iframe via postMessage:', {
                        auth_token_V2: token,
                        current_user: currentUser,
                        loggedInBusinessId: userdata.LogInUserInfo.BusinessId,
                        isSSO: 'true',
                      });

                      // Remove the event listener after the message is sent
                      window.removeEventListener('message', handleReadyMessage);
                    }
                  });

                  console.log('Waiting for iframe to signal readiness...');
                } else {
                  console.error('Iframe not found.');
                }
              }
              callback();
            },
            focus(api, state) {
              console.log('User has clicked the add-in and is focused on the UI');
            },
            blur(api, state) {
              console.log('User has navigated away from the add-in');
            },
          };
        };
      }
    </script>
  </head>

  <body>
    <iframe width="100%" height="100%" id="login-iframe" src="https://tripvisionqa.noregon.com/auth/sso"></iframe>
  </body>
</html>
