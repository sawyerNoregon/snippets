<html>
  <head>
    <title>TripVision Single Sign-On</title>
    <script>
      const API_BASE_URL = 'https://tvapi2qa.noregon.com/api/v2/i/users/';
      const TRIPVISION_BASE_URL = 'https://tripvisionqa.noregon.com/';

      console.log('May 5th Geotab Plugin');
      initializeGeotabAddin();

      function initializeGeotabAddin() {
        geotab.addin.myCustomPage1 = () => {
          return {
            initialize(api, state, callback) {
              console.log('Add-in initialized');

              // Automatically calls SSOWrapper when the page is loaded
              SSOWrapper();

              function SSOWrapper() {
                try {
                  logUserDetails();
                  SSOfunction();
                } catch (error) {
                  console.error('Error in SSOWrapper:', error);
                  // redirectToTripVision('auth');
                }
              }

              function logUserDetails() {
                api.getSession(function (session) {
                  const userName = session.userName;
                  console.log(JSON.stringify(session.sessionId));
                  api.call(
                    'Get',
                    {
                      typeName: 'User',
                      resultsLimit: 1,
                      propertySelector: { fields: ['id', 'companyGroups'] },
                      search: { name: userName },
                    },
                    function (apiresult) {
                      const userId = apiresult[0].id;
                      const companyGroups = apiresult[0].companyGroups
                        .map((group) => group.id)
                        .join(', ');

                      console.log('User ID:', userId);
                      console.log('Company Groups:', companyGroups);
                    },
                  );
                });
              }

              // fetch(`${API_BASE_URL}log-in-geotab?Username=${JSON.stringify(session.userName)}&DatabaseName=${JSON.stringify(session.database)}&SessionID=${JSON.stringify(session.sessionId)}&ServerName=${JSON.stringify(server)}`, {

              function SSOfunction() {
                api.getSession(function (session, server) {
                  console.log('Session:', session);
                  fetch(
                    `${API_BASE_URL}log-in-geotab?Username=${session.userName}&DatabaseName=${session.database}&SessionID=${session.sessionId}&ServerName=${server}`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        Username: session.userName,
                        DatabaseName: session.database,
                        SessionID: session.sessionId,
                        ServerName: server,
                      }),
                    },
                  )
                    .then((response) => {
                      if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                      }
                      return response.json();
                    })
                    .then((data) => {
                      console.log('Successfully called TV API:', data);

                      if (data.ViewWhatsNew) {
                        console.log("User should view What's New modal");
                        redirectToTripVision('whats-new');
                      } else if (data.ReturnCode !== 0) {
                        console.error('Error in login response:', data.ErrorMessage);
                        redirectToTripVision('auth');
                        return;
                      }
                      
                      const loginToken = data.Token;
                      const userInfo = data.LogInUserInfo;
                      const userPreferences = data.UserPreferences;
                      loginUser(loginToken, data.userInfo, data.userPreferences);
                    })
                    .catch(async (error) => {
                      const errorBody = await response.text();
                      console.error('Error retrieving token:', error, errorBody);
                      redirectToTripVision('auth');
                    });
                });
              }

              function redirectToTripVision(route) {
                const iframe = document.getElementById('login-iframe');
                const src = `${TRIPVISION_BASE_URL}${route}`;

                if (iframe) {
                  iframe.src = src; // Update the iframe's src attribute to redirect
                  console.log('Redirecting iframe to:', src);
                } else {
                  console.error('Iframe not found. Unable to redirect.');
                }
              }

              function loginUser(token, userInfo, userPreferences) {
                localStorage.setItem('auth_token_V2', token);
                localStorage.setItem('isSSO', true);
                localStorage.setItem('user_info', JSON.stringify(userInfo));
                localStorage.setItem('user_preferences', JSON.stringify(userPreferences));

                console.log('User authenticated with token:', token);
                console.log('User info stored:', userInfo);
                console.log('User preferences stored:', userPreferences);

                // Redirect based on preferences
                if (userPreferences && userPreferences.ShowDashboardAsLanding) {
                  redirectToTripVision('dashboard');
                } else {
                  redirectToTripVision('vehicles');
                }
              }
              callback();
            },
            focus(api, state) {
              console.log('User has clicked the add-in and is focused on the UI');
            },
            blur(api, state) {
              console.log('User has navigated away from the add-in');
            },
          };
        };
      }
    </script>
  </head>

  <body>
    <iframe width="100%" height="100%" id="login-iframe"></iframe>
  </body>
</html>
